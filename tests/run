#!/usr/bin/env bash

set -eu

readonly DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

readonly JAVADIR="$DIR/../lib/java.spfx/lang.java"
if [ ! -d "$JAVADIR" ]; then
    echo "FAILURE: Cannot find directory $JAVADIR"
    exit 1
fi

readonly SUNSHINE_JAR="$DIR/../bin/org.metaborg.sunshine2-2.6.0-SNAPSHOT.jar"
if [ ! -f "$SUNSHINE_JAR" ]; then
    echo "FAILURE: Cannot find file $SUNSHINE_JAR"
    exit 1
fi

readonly SUNSHINE="java -jar $SUNSHINE_JAR"

for infile in "$@"
do
    if ! (echo $infile | grep -s "no.java") 
    then
        positive=0
	echo "Expect pass"
    else
        positive=1
	echo "Expect fail"
    fi

    # make sure to remove all class files to avoid incidental capture
    rm -f $(dirname "$infile")/*.class

    # run java compiler
    javac $infile 2>&1 | tee ${infile%.java}.javac.out 
    java_ok=${PIPESTATUS[0]}

    # compile the file to an aterm
    jav=${infile%.java}.jav
    cp "$infile" $jav
    ${SUNSHINE} transform -n "Explicate injections" -l "${JAVADIR}" -p . -i ${infile%.java}.jav > ${infile%.java}.aterm 2> /dev/null

    # run statix on the aterm
    statix check -I $DIR/../src/ java ${infile%.java}.aterm 2>&1 | tee ${infile%.java}.stx.out
    stx_ok=${PIPESTATUS[0]}

    # compute test result by comparison
    if [ $java_ok -eq $stx_ok -a $java_ok -eq $positive ]
    then
        echo -e "[\e[32mSUCCESS\e[0m] $infile"
    else
        echo -e "[\e[31mFAILURE\e[0m] $infile"
    fi
done
