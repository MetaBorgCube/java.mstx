#!/usr/bin/env bash

set -eu

readonly DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"

readonly JAVADIR="$DIR/../lib/java.spfx/lang.java"
if [ ! -d "$JAVADIR" ]; then
    echo "FAILURE: Cannot find directory $JAVADIR"
    exit 1
fi

readonly SUNSHINE="$DIR/../bin/org.metaborg.sunshine2-2.5.2.jar"
if [ ! -f "$SUNSHINE" ]; then
    echo "FAILURE: Cannot find file $SUNSHINE"
    exit 1
fi

readonly ATERM="java -jar $SUNSHINE parse -l $JAVADIR -p . -i"

for infile in "$@"
do
    if ! (echo $infile | grep -s "no.java") 
    then
        positive=0
	echo "Expect pass"
    else
        positive=1
	echo "Expect fail"
    fi

    javac $infile 2>&1 | tee ${infile%.java}.javac.out 
    java_ok=${PIPESTATUS[0]}

    jav=${infile%.java}.jav
    cp "$infile" $jav
    ${ATERM} ${infile%.java}.jav > ${infile%.java}.aterm 2> /dev/null
    statix $DIR/../src/java.mstx ${infile%.java}.aterm 2>&1 | tee ${infile%.java}.stx.out
    stx_ok=${PIPESTATUS[0]}

    if [ $java_ok -eq $stx_ok -a $java_ok -eq $positive ]
    then
	echo -e "[\e[32mSUCCESS\e[0m] $infile"
    else
	echo -e "[\e[31mFAILURE\e[0m] $infile"
    fi
done
